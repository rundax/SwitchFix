name: Release Build

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.runner }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        runner:
          - macos-13
          - macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: "5.9"

      - name: Determine architecture label
        run: |
          ARCH="$(uname -m)"
          if [ "$ARCH" = "arm64" ]; then
            echo "ASSET_ARCH=arm64" >> "$GITHUB_ENV"
          elif [ "$ARCH" = "x86_64" ]; then
            echo "ASSET_ARCH=intel" >> "$GITHUB_ENV"
          else
            echo "Unsupported architecture: $ARCH"
            exit 1
          fi
          echo "Runner architecture: $ARCH"

      - name: Check for Apple certificates
        id: cert_check
        env:
          P12: ${{ secrets.APPLE_CERTIFICATE_P12_BASE64 }}
          PWD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APP_ID: ${{ secrets.SWITCHFIX_CODESIGN_IDENTITY }}
        run: |
          if [ -n "$P12" ] && [ -n "$PWD" ] && [ -n "$APP_ID" ]; then
             echo "has_certs=true" >> "$GITHUB_OUTPUT"
          else
             echo "has_certs=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Import signing certificate (optional)
        if: steps.cert_check.outputs.has_certs == 'true'
        env:
          APPLE_CERTIFICATE_P12_BASE64: ${{ secrets.APPLE_CERTIFICATE_P12_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          CERT_PATH="$RUNNER_TEMP/switchfix-signing-cert.p12"
          KEYCHAIN_PATH="$RUNNER_TEMP/switchfix-signing.keychain-db"
          KEYCHAIN_PASSWORD="$(uuidgen)"

          echo "$APPLE_CERTIFICATE_P12_BASE64" | base64 --decode > "$CERT_PATH" 2>/dev/null || \
          echo "$APPLE_CERTIFICATE_P12_BASE64" | base64 -D > "$CERT_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security import "$CERT_PATH" -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security find-identity -v -p codesigning

      - name: Build App
        env:
          SWITCHFIX_CODESIGN_IDENTITY: ${{ secrets.SWITCHFIX_CODESIGN_IDENTITY }}
        run: |
          chmod +x scripts/build-app.sh
          scripts/build-app.sh

      - name: Create DMG
        env:
          SWITCHFIX_DMG_NAME: SwitchFix-${{ env.ASSET_ARCH }}
        run: |
          chmod +x scripts/create-dmg.sh
          scripts/create-dmg.sh

      - name: Zip App Bundle
        run: |
          cd dist
          zip -r "SwitchFix-${ASSET_ARCH}.app.zip" SwitchFix.app
          cd ..

      - name: Collect release assets
        run: |
          mkdir -p release-assets
          cp "dist/SwitchFix-${ASSET_ARCH}.dmg" release-assets/
          cp "dist/SwitchFix-${ASSET_ARCH}.app.zip" release-assets/
          if [ "$ASSET_ARCH" = "arm64" ]; then
            cp "Resources/Assets.xcassets/AppIcon.svg" "release-assets/AppIcon.svg"
          fi

      - name: Upload release assets
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-${{ env.ASSET_ARCH }}
          path: release-assets/*
          if-no-files-found: error

  release:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download all release artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          pattern: release-assets-*
          merge-multiple: true

      - name: Show collected assets
        run: ls -la release-assets

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            release-assets/*.dmg
            release-assets/*.zip
            release-assets/*.svg
          generate_release_notes: true
